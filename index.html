<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ í˜¼í¬ë§íƒ€ìš´ ëª¨ê¸°ì§€ í†µí•© ê³„ì‚°ê¸°</title>
    <meta name="description" content="ì‹ í˜¼í¬ë§íƒ€ìš´ ìˆ˜ìµê³µìœ í˜• ëª¨ê¸°ì§€ ê³„ì‚°ê¸° ë° ì „ì²´ ì •ì‚°í‘œ(1~30ë…„) ì œê³µ.">
    
    <!-- Bootstrap 5 & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #20c997; --dark-green: #0ca678; }
        body { background-color: #f0f2f5; font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; padding-top: 70px; }
        
        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .navbar-custom { background: linear-gradient(135deg, #20c997 0%, #0ca678 100%); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .navbar-custom .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 600; font-size: 1rem; }
        .navbar-custom .nav-link.active { color: #fff !important; font-weight: 800; border-bottom: 3px solid #fff; }

        /* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .page-section { display: none; max-width: 600px; margin: 0 auto 40px auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }
        .calc-body { padding: 30px 25px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ í¼ ìš”ì†Œ */
        .step-section { margin-bottom: 25px; border: 1px solid #eee; border-radius: 12px; padding: 20px; background-color: #fff; position: relative; }
        .step-badge { position: absolute; top: -12px; left: 15px; background: #333; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .form-label { font-weight: 700; font-size: 0.95rem; color: #444; }
        .input-group-text { background-color: #f8f9fa; }

        /* ê¸ˆì•¡ í•œê¸€ í‘œê¸° ìŠ¤íƒ€ì¼ (ì¶”ê°€ë¨) */
        .money-ko { font-size: 0.8rem; color: #20c997; font-weight: bold; margin-top: 5px; margin-left: 2px; }

        /* LTV ë²„íŠ¼ ê·¸ë£¹ */
        .btn-check:checked + .btn-outline-custom { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        .btn-outline-custom { border: 1px solid #ced4da; color: #555; background-color: white; }
        .btn-outline-custom:hover { background-color: #e6fcf5; }

        /* ì •ì‚°í‘œ íƒ­ ìŠ¤íƒ€ì¼ */
        .nav-tabs .nav-link { color: #555; font-weight: 600; border-radius: 10px 10px 0 0; }
        .nav-tabs .nav-link.active { color: var(--primary-color); font-weight: 800; border-color: #dee2e6 #dee2e6 #fff; }
        
        /* ì •ì‚°í‘œ í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .full-table-container { max-height: 600px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0 0 8px 8px; }
        .table-rate thead th { position: sticky; top: 0; background-color: #343a40; color: white; z-index: 1; text-align: center; font-size: 0.9rem; padding: 12px 0; }
        .table-rate tbody td { text-align: center; font-size: 0.9rem; vertical-align: middle; padding: 8px 0; border-bottom: 1px solid #eee; }
        .table-rate tbody tr:nth-child(even) { background-color: #f8f9fa; }
        
        /* ê²°ê³¼ ë°•ìŠ¤ */
        .result-box { background-color: #f8f9fa; border-radius: 15px; padding: 25px; border: 1px solid #e9ecef; }
        .cagr-badge { font-size: 0.85rem; margin-top: 8px; display: block; text-align: right; color: var(--dark-green); font-weight: bold; }
        
        .ad-banner { background-color: #e9ecef; height: 90px; display: flex; align-items: center; justify-content: center; color: #adb5bd; border-radius: 8px; margin: 15px 0; border: 1px dashed #ced4da; font-size: 0.8rem; }
    </style>
</head>
<body>

<!-- 1. ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand navbar-dark navbar-custom fixed-top">
    <div class="container-fluid justify-content-center">
        <ul class="navbar-nav flex-row">
            <li class="nav-item mx-3">
                <a class="nav-link active" href="#" onclick="switchTab('calc', this)"><i class="bi bi-calculator"></i> ê³„ì‚°ê¸°</a>
            </li>
            <li class="nav-item mx-3">
                <a class="nav-link" href="#" onclick="switchTab('table', this)"><i class="bi bi-table"></i> ì •ì‚°í‘œ</a>
            </li>
            <li class="nav-item mx-3">
                <a class="nav-link" href="https://apply.lh.or.kr" target="_blank"><i class="bi bi-building"></i> ë¶„ì–‘í˜„í™©</a>
            </li>
        </ul>
    </div>
</nav>

<!-- PAGE 1: ëª¨ê¸°ì§€ ê³„ì‚°ê¸° -->
<div id="page-calc" class="page-section active">
    <div class="calc-body text-dark">
        
        <div class="ad-banner"><span>ê´‘ê³  ì˜ì—­ (ìƒë‹¨)</span></div>

        <form id="calcForm" onsubmit="return false;">
            
            <!-- STEP 1 -->
            <div class="step-section">
                <span class="step-badge">STEP 1</span>
                <div class="mb-3">
                    <label class="form-label">ë¶„ì–‘ê°€ (ì…ì£¼ê¸ˆ)</label>
                    <div class="input-group">
                        <input type="text" class="form-control text-end fw-bold" id="purchasePrice" placeholder="0" onkeyup="inputNumberFormat(this)" required>
                        <span class="input-group-text">ë§Œì›</span>
                    </div>
                    <!-- í•œê¸€ ê¸ˆì•¡ í‘œì‹œ ì˜ì—­ -->
                    <div id="text-purchasePrice" class="money-ko"></div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">ìë…€ ìˆ˜</label>
                        <select class="form-select" id="kids">
                            <option value="0">0ëª…</option>
                            <option value="1">1ëª…</option>
                            <option value="2">2ëª… ì´ìƒ</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="form-label">ì…ì£¼(ëŒ€ì¶œ) ì‹œê¸°</label>
                        <input type="month" class="form-control" id="startDate" required>
                    </div>
                </div>
            </div>

            <!-- STEP 2: ëŒ€ì¶œ ë° ê¸ˆë¦¬ -->
            <div class="step-section">
                <span class="step-badge">STEP 2</span>
                
                <label class="form-label">ëŒ€ì¶œ ê¸ˆì•¡ (LTV ì„ íƒ)</label>
                <div class="input-group mb-2">
                    <input type="text" class="form-control text-end fw-bold" id="loanAmount" placeholder="ê¸ˆì•¡ ìë™ ì…ë ¥" onkeyup="inputNumberFormat(this)" required>
                    <span class="input-group-text">ë§Œì›</span>
                </div>
                <!-- í•œê¸€ ê¸ˆì•¡ í‘œì‹œ ì˜ì—­ -->
                <div id="text-loanAmount" class="money-ko mb-2"></div>

                <!-- LTV ë²„íŠ¼ -->
                <div class="btn-group w-100 mb-3" role="group">
                    <button class="btn btn-outline-custom btn-sm" onclick="setLTV(70)">70%</button>
                    <button class="btn btn-outline-custom btn-sm" onclick="setLTV(60)">60%</button>
                    <button class="btn btn-outline-custom btn-sm" onclick="setLTV(50)">50%</button>
                    <button class="btn btn-outline-custom btn-sm" onclick="setLTV(40)">40%</button>
                    <button class="btn btn-outline-custom btn-sm" onclick="setLTV(30)">30%</button>
                </div>
                <div class="text-end mb-3">
                    <span class="badge bg-light text-dark border" id="ltvDisplay">LTV: - %</span>
                    <span class="badge bg-danger" id="limitWarning" style="display:none;">í•œë„ 4ì–µ ì´ˆê³¼</span>
                </div>

                <div class="row">
                    <div class="col-6">
                        <label class="form-label">ëŒ€ì¶œ ê¸ˆë¦¬</label>
                        <div class="input-group input-group-sm mb-1">
                            <input type="number" class="form-control" id="hopeRate" value="1.3" step="0.1">
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="btn-group w-100 btn-group-sm">
                            <button class="btn btn-outline-secondary" onclick="setRate(1.3)">1.3%</button>
                            <button class="btn btn-outline-secondary" onclick="setRate(1.6)">1.6%</button>
                        </div>
                    </div>
                    <div class="col-6">
                        <label class="form-label">ëŒ€ì¶œ ë§Œê¸°</label>
                        <select class="form-select" id="termOptions">
                            <option value="30">30ë…„ (1ë…„ê±°ì¹˜)</option>
                            <option value="20">20ë…„ (1ë…„ê±°ì¹˜)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ì¤‘ê°„ ê´‘ê³  -->
            <div class="ad-banner"><span>ê´‘ê³  ì˜ì—­ (ì¤‘ê°„)</span></div>

            <!-- STEP 3: ë§¤ë„ ë° ìˆ˜ìµë¥  -->
            <div class="step-section border-primary border-opacity-25" style="background-color: #f8fffc;">
                <span class="step-badge bg-primary">STEP 3</span>
                
                <div class="mb-3">
                    <label class="form-label">ì˜ˆìƒ ë§¤ë„ ì‹œê¸°</label>
                    <input type="month" class="form-control" id="endDate" onchange="calcDurationAndCAGR()" required>
                    <div class="text-end mt-1">
                        <span class="badge bg-secondary" id="durationBadge">ê¸°ê°„ ë¯¸ì…ë ¥</span>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ì˜ˆìƒ ë§¤ë„ ê°€ê²©</label>
                    <div class="input-group">
                        <input type="text" class="form-control text-end fw-bold" id="sellPrice" placeholder="0" onkeyup="updateCAGR(this)" required>
                        <span class="input-group-text">ë§Œì›</span>
                    </div>
                    <!-- í•œê¸€ ê¸ˆì•¡ í‘œì‹œ ì˜ì—­ -->
                    <div id="text-sellPrice" class="money-ko"></div>
                    
                    <span id="cagrDisplay" class="cagr-badge"></span>
                </div>
            </div>

            <!-- ë¹„êµêµ° -->
            <div class="mb-4 px-2">
                <label class="form-label text-muted small"><i class="bi bi-bank"></i> ë¹„êµìš© ì¼ë°˜ ì£¼ë‹´ëŒ€ ê¸ˆë¦¬</label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="normalRate" value="4.5" step="0.1">
                    <span class="input-group-text">%</span>
                </div>
            </div>

            <button class="btn btn-success w-100 py-3 fw-bold shadow-sm fs-5" style="background-color:var(--primary-color); border:none;" onclick="calculate()">
                ê²°ê³¼ ë¶„ì„í•˜ê¸°
            </button>
        </form>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div id="resultBox" class="result-box mt-4" style="display:none;">
            <h5 class="fw-bold text-center mb-3">ğŸ“Š ë¶„ì„ ê²°ê³¼</h5>
            
            <div id="verdictBox" class="alert text-center fw-bold mb-3 small"></div>

            <table class="table table-bordered bg-white small align-middle mb-3">
                <thead class="table-light text-center">
                    <tr>
                        <th width="30%">í•­ëª©</th>
                        <th width="35%">ì‹ í¬íƒ€</th>
                        <th width="35%">ì¼ë°˜ëŒ€ì¶œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="bg-light text-center">ì‹œì„¸ì°¨ìµ</td>
                        <td colspan="2" class="text-center fw-bold text-primary">+<span id="resGain">0</span>ë§Œ</td>
                    </tr>
                    <tr>
                        <td class="bg-light text-center">ì´ ì´ì</td>
                        <td class="text-end text-danger">-<span id="resHopeInt">0</span>ë§Œ</td>
                        <td class="text-end text-danger">-<span id="resNormInt">0</span>ë§Œ</td>
                    </tr>
                    <tr>
                        <td class="bg-light text-center fw-bold text-danger">LH í™˜ìˆ˜ê¸ˆ</td>
                        <td class="text-end text-danger fw-bold bg-warning bg-opacity-10">
                            -<span id="resShare">0</span>ë§Œ<br>
                            <span style="font-size:0.7em;">(í™˜ìˆ˜ìœ¨ <span id="resShareRate">0</span>%)</span>
                        </td>
                        <td class="text-center text-muted">-</td>
                    </tr>
                    <tr class="table-group-divider">
                        <td class="bg-dark text-white text-center">ìµœì¢…ìˆ˜ìµ</td>
                        <td class="text-end fw-bold text-success"><span id="resHopeProfit">0</span>ë§Œ</td>
                        <td class="text-end fw-bold text-secondary"><span id="resNormProfit">0</span>ë§Œ</td>
                    </tr>
                </tbody>
            </table>

            <!-- ì›” ë‚©ë¶€ì•¡ ë¹„êµ ì¹´ë“œ -->
            <div class="card border-0 bg-light mb-3">
                <div class="card-body p-3">
                    <h6 class="card-title fw-bold small mb-3 text-center">
                        <i class="bi bi-wallet2"></i> ì›” ì˜ˆìƒ ë‚©ë¶€ì•¡ ë¹„êµ
                    </h6>
                    
                    <div class="row g-2">
                        <!-- ì‹ í˜¼í¬ë§íƒ€ìš´ -->
                        <div class="col-6">
                            <div class="p-2 bg-white rounded border text-center h-100">
                                <div class="badge bg-success mb-2">ì‹ í˜¼í¬ë§íƒ€ìš´</div>
                                <div class="small text-muted mb-1">ì´ˆê¸° 1ë…„ (ì´ìë§Œ)</div>
                                <div class="fw-bold mb-2"><span id="pmtInterestOnly">0</span>ì›</div>
                                <div class="small text-muted mb-1">2ë…„ì°¨~ (ì›ë¦¬ê¸ˆ)</div>
                                <div class="fw-bold text-success fs-5"><span id="pmtFull">0</span>ì›</div>
                            </div>
                        </div>

                        <!-- ì¼ë°˜ ì£¼ë‹´ëŒ€ -->
                        <div class="col-6">
                            <div class="p-2 bg-white rounded border text-center h-100">
                                <div class="badge bg-secondary mb-2">ì¼ë°˜ ì£¼ë‹´ëŒ€</div>
                                <div class="small text-muted mb-1">ë§¤ì›” (ì›ë¦¬ê¸ˆ)</div>
                                <div class="fw-bold text-secondary fs-5 mt-4"><span id="normPmtFull">0</span>ì›</div>
                                <div class="mt-2" style="font-size: 0.7rem; color: #dc3545;">
                                    (ì›” +<span id="diffPmt">0</span>ì› ë” ëƒ„)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ad-banner"><span>ê´‘ê³  ì˜ì—­ (ê²°ê³¼ì°½)</span></div>
        </div>

        <div class="text-center mt-4 pt-3 border-top">
            <p class="text-muted" style="font-size: 0.7rem;">
                * ë³¸ ê³„ì‚°ê¸°ëŠ” ì‹œë®¬ë ˆì´ì…˜ ìš©ë„ì´ë©° ë²•ì  íš¨ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                * LTV 70% êµ¬ê°„ì˜ ìë…€ ìˆ˜ë³„ ìµœì €í•œë„(20%, 15%)ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                * ì‹¤ì œ ëŒ€ì¶œ ì¡°ê±´ ë° ì„¸ê¸ˆì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>
    </div>
</div>

<!-- PAGE 2: ì •ì‚°í‘œ (ì „ì²´) -->
<div id="page-table" class="page-section">
    <div class="calc-body text-dark">
        <h4 class="fw-bold text-center mb-4">ğŸ“œ ìˆ˜ìµê³µìœ  ëª¨ê¸°ì§€ ì •ì‚°í‘œ</h4>
        
        <div class="ad-banner"><span>ê´‘ê³  ì˜ì—­</span></div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-0 justify-content-center" id="tableTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-btn-70" data-bs-toggle="tab" data-bs-target="#content-70" type="button" role="tab">70%</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-btn-60" data-bs-toggle="tab" data-bs-target="#content-60" type="button" role="tab">60%</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-btn-50" data-bs-toggle="tab" data-bs-target="#content-50" type="button" role="tab">50%</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-btn-40" data-bs-toggle="tab" data-bs-target="#content-40" type="button" role="tab">40%</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-btn-30" data-bs-toggle="tab" data-bs-target="#content-30" type="button" role="tab">30%</button>
            </li>
        </ul>

        <!-- íƒ­ ì½˜í…ì¸  -->
        <div class="tab-content" id="tableTabContent">
            <!-- íƒ­ ë‚´ìš©ì€ JSë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤ -->
            <div class="tab-pane fade show active" id="content-70" role="tabpanel"></div>
            <div class="tab-pane fade" id="content-60" role="tabpanel"></div>
            <div class="tab-pane fade" id="content-50" role="tabpanel"></div>
            <div class="tab-pane fade" id="content-40" role="tabpanel"></div>
            <div class="tab-pane fade" id="content-30" role="tabpanel"></div>
        </div>

        <p class="text-center text-muted small mt-3">
            â€» ë³´ìœ ê¸°ê°„ 1~9ë…„ì°¨ëŠ” ê³ ì •ë¹„ìœ¨, 10ë…„ì°¨ë¶€í„° ë§¤ë…„ 2%pì”© ì°¨ê°.<br>
            â€» LTV 70% êµ¬ê°„ì€ 20% ë° 15% í•˜í•œì„  ì¡´ì¬.
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- 1. íƒ­ ì „í™˜ ë° ì´ˆê¸°í™” ---
    function switchTab(pageId, navElement) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.navbar-nav .nav-link').forEach(el => el.classList.remove('active'));
        if(navElement) navElement.classList.add('active');
    }

    window.onload = function() {
        document.getElementById('startDate').value = new Date().toISOString().slice(0, 7);
        generateAllTables();
    }

    // --- 2. ì…ë ¥ ë° ê³„ì‚° ìœ í‹¸ ---
    function inputNumberFormat(obj) { 
        obj.value = comma(uncomma(obj.value)); 
        updateCAGR(); 
        checkInputs(); 
    }

    function comma(str) { return String(str).replace(/(\d)(?=(?:\d{3})+(?!\d))/g, '$1,'); }
    function uncomma(str) { return String(str).replace(/[^\d]+/g, ''); }
    function getNum(id) { return parseFloat(uncomma(document.getElementById(id).value)) || 0; }
    function setNum(id, val) { document.getElementById(id).value = comma(Math.round(val)); }

    function setRate(rate) { document.getElementById('hopeRate').value = rate; }

    function setLTV(percent) {
        const price = getNum('purchasePrice');
        if (price === 0) { alert("ë¶„ì–‘ê°€ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”"); return; }
        let loan = price * (percent / 100);
        if (loan > 40000) loan = 40000;
        setNum('loanAmount', loan);
        checkInputs();
    }

    // [NEW] í•œê¸€ ê¸ˆì•¡ ë³€í™˜ í•¨ìˆ˜
    function koreanMoney(val) {
        if (!val || val == 0) return "";
        const eok = Math.floor(val / 10000);
        const man = val % 10000;
        let str = "";
        if (eok > 0) str += `${eok}ì–µ `;
        if (man > 0) str += `${comma(man)}ë§Œì›`;
        if (str === "") return "";
        return "(" + str.trim() + ")";
    }

    // [MODIFIED] ì…ë ¥ê°’ ì²´í¬ ë° í•œê¸€ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
    function checkInputs() {
        const price = getNum('purchasePrice');
        const loan = getNum('loanAmount');
        const ltvBox = document.getElementById('ltvDisplay');
        const limitMsg = document.getElementById('limitWarning');

        // í•œê¸€ ê¸ˆì•¡ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('text-purchasePrice').innerText = koreanMoney(price);
        document.getElementById('text-loanAmount').innerText = koreanMoney(loan);

        if (price > 0 && loan > 0) {
            const ltv = (loan / price) * 100;
            ltvBox.innerText = `LTV: ${ltv.toFixed(1)}%`;
            if (loan > 40000) { limitMsg.style.display = 'inline-block'; } 
            else { limitMsg.style.display = 'none'; }
        }
    }

    function calcDurationAndCAGR() {
        const startStr = document.getElementById('startDate').value;
        const endStr = document.getElementById('endDate').value;
        const badge = document.getElementById('durationBadge');
        
        if(!startStr || !endStr) return 0;

        const start = new Date(startStr + "-01");
        const end = new Date(endStr + "-01");
        
        let months = (end.getFullYear() - start.getFullYear()) * 12;
        months -= start.getMonth();
        months += end.getMonth();

        if (months <= 0) {
            badge.innerText = "ë‚ ì§œ ì˜¤ë¥˜";
            badge.className = "badge bg-danger";
            updateCAGR();
            return -1;
        }

        const years = Math.floor(months / 12);
        const remain = months % 12;
        badge.innerText = `${years}ë…„ ${remain}ê°œì›”`;
        badge.className = "badge bg-success";
        
        updateCAGR();
        return months / 12; 
    }

    function updateCAGR(obj) {
        if(obj) inputNumberFormat(obj);
        
        const buy = getNum('purchasePrice');
        const sell = getNum('sellPrice');

        // [NEW] ë§¤ë„ ê°€ê²© í•œê¸€ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('text-sellPrice').innerText = koreanMoney(sell);

        const startStr = document.getElementById('startDate').value;
        const endStr = document.getElementById('endDate').value;
        if(!startStr || !endStr) return;

        const start = new Date(startStr + "-01");
        const end = new Date(endStr + "-01");
        let months = (end.getFullYear() - start.getFullYear()) * 12;
        months -= start.getMonth();
        months += end.getMonth();
        const years = months / 12;
        const display = document.getElementById('cagrDisplay');

        if (buy > 0 && sell > 0 && years >= 1) {
            const cagr = (Math.pow(sell / buy, 1 / years) - 1) * 100;
            display.innerText = `ğŸ  ì—°í‰ê·  ì§‘ê°’ ìƒìŠ¹ë¥ : ${cagr.toFixed(2)}%`;
        } else {
            display.innerText = "";
        }
    }

    // --- 3. ì •ì‚°í‘œ ì „ì²´ ìƒì„± ë¡œì§ (1~30ë…„) ---
    function generateAllTables() {
        const configs = [
            { id: 'content-70', ltv: 70, start: [50, 40, 30], min: [20, 15, 10] },
            { id: 'content-60', ltv: 60, start: [45, 35, 25], min: [10, 10, 10] },
            { id: 'content-50', ltv: 50, start: [40, 30, 20], min: [10, 10, 10] },
            { id: 'content-40', ltv: 40, start: [35, 25, 15], min: [10, 10, 10] },
            { id: 'content-30', ltv: 30, start: [30, 20, 10], min: [10, 10, 10] }
        ];

        configs.forEach(cfg => {
            let html = `
                <div class="full-table-container">
                <table class="table table-rate mb-0">
                    <thead><tr><th>ë³´ìœ ê¸°ê°„</th><th>0ìë…€</th><th>1ìë…€</th><th>2ìë…€+</th></tr></thead>
                    <tbody>
            `;

            for(let yr = 1; yr <= 30; yr++) {
                let reduce = (yr < 10) ? 0 : (yr - 9) * 2;
                let r0 = Math.max(cfg.min[0], cfg.start[0] - reduce);
                let r1 = Math.max(cfg.min[1], cfg.start[1] - reduce);
                let r2 = Math.max(cfg.min[2], cfg.start[2] - reduce);

                html += `<tr>
                    <td><strong>${yr}ë…„</strong></td>
                    <td class="${r0===cfg.min[0] ? 'text-primary fw-bold':''}">${r0}%</td>
                    <td class="${r1===cfg.min[1] ? 'text-primary fw-bold':''}">${r1}%</td>
                    <td class="${r2===cfg.min[2] ? 'text-primary fw-bold':''}">${r2}%</td>
                </tr>`;
            }
            html += `</tbody></table></div>`;
            document.getElementById(cfg.id).innerHTML = html;
        });
    }

    // --- 4. ë©”ì¸ ê³„ì‚° ---
    function calculate() {
        try {
            const price = getNum('purchasePrice');
            const loan = getNum('loanAmount');
            const sell = getNum('sellPrice');
            const kids = parseInt(document.getElementById('kids').value);
            const term = parseInt(document.getElementById('termOptions').value);
            const hopeRate = parseFloat(document.getElementById('hopeRate').value);
            const normRate = parseFloat(document.getElementById('normalRate').value);
            
            const startStr = document.getElementById('startDate').value;
            const endStr = document.getElementById('endDate').value;
            
            if(!startStr || !endStr) { alert("ê¸°ê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            const start = new Date(startStr + "-01");
            const end = new Date(endStr + "-01");
            let months = (end.getFullYear() - start.getFullYear()) * 12;
            months -= start.getMonth();
            months += end.getMonth();
            const durationYears = months / 12;

            if (price === 0 || loan === 0 || sell === 0) { alert("ëª¨ë“  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (durationYears <= 0) { alert("ë§¤ë„ ì‹œê¸°ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤."); return; }

            const gain = sell - price;

            // í™˜ìˆ˜ê¸ˆ ê³„ì‚°
            const ltv = (loan / price) * 100;
            let shareRate = 0;
            if (gain > 0 && ltv >= 30) {
                let bucket = Math.ceil(ltv / 10) * 10;
                if(bucket < 30) bucket = 30; if(bucket > 70) bucket = 70;

                const baseRates = {
                    70: [50, 40, 30], 60: [45, 35, 25], 50: [40, 30, 20],
                    40: [35, 25, 15], 30: [30, 20, 10]
                };
                let startRate = baseRates[bucket][kids];
                let reduction = Math.max(0, Math.floor(durationYears) - 9) * 2;
                let calcRate = startRate - reduction;

                let minLimit = 10;
                if (bucket === 70) {
                    if (kids === 0) minLimit = 20;
                    else if (kids === 1) minLimit = 15;
                }
                shareRate = Math.max(calcRate, minLimit);
            }
            const shareAmount = (gain > 0) ? gain * (shareRate / 100) : 0;

            // ì´ì ê³„ì‚° (ë§Œì› ë‹¨ìœ„ ê¸°ì¤€)
            const hopeResult = calcLoanDetails(loan, hopeRate/100, term, durationYears, 1);
            const normResult = calcLoanDetails(loan, normRate/100, 30, durationYears, 0);

            const hopeProfit = gain - shareAmount - hopeResult.totalInterest;
            const normProfit = gain - normResult.totalInterest;

            // ê²°ê³¼ í‘œì‹œ (ë‹¨ìœ„: ë§Œì›)
            document.getElementById('resGain').innerText = comma(gain);
            document.getElementById('resHopeInt').innerText = comma(Math.round(hopeResult.totalInterest));
            document.getElementById('resNormInt').innerText = comma(Math.round(normResult.totalInterest));
            document.getElementById('resShare').innerText = comma(Math.round(shareAmount));
            document.getElementById('resShareRate').innerText = shareRate;
            document.getElementById('resHopeProfit').innerText = comma(Math.round(hopeProfit));
            document.getElementById('resNormProfit').innerText = comma(Math.round(normProfit));

            // ì›” ë‚©ë¶€ì•¡ í‘œì‹œ (ë‹¨ìœ„: ì›)
            const hopeMonthly = Math.round(hopeResult.monthlyFull * 10000);
            const hopeInterestOnly = Math.round(hopeResult.monthlyInterestOnly * 10000);
            const normMonthly = Math.round(normResult.monthlyFull * 10000);
            const diffMonthly = normMonthly - hopeMonthly;

            document.getElementById('pmtInterestOnly').innerText = comma(hopeInterestOnly);
            document.getElementById('pmtFull').innerText = comma(hopeMonthly);
            document.getElementById('normPmtFull').innerText = comma(normMonthly);
            document.getElementById('diffPmt').innerText = comma(diffMonthly);

            const diff = hopeProfit - normProfit;
            const vBox = document.getElementById('verdictBox');
            if (diff > 0) {
                vBox.className = "alert alert-success text-center fw-bold mb-3";
                vBox.innerHTML = `ì‹ í¬íƒ€ê°€ ${comma(Math.round(diff))}ë§Œì› ë” ìœ ë¦¬í•©ë‹ˆë‹¤! ğŸ‰`;
            } else if (diff < 0) {
                vBox.className = "alert alert-danger text-center fw-bold mb-3";
                vBox.innerHTML = `ì¼ë°˜ëŒ€ì¶œì´ ${comma(Math.round(Math.abs(diff)))}ë§Œì› ë” ìœ ë¦¬í•©ë‹ˆë‹¤.`;
            } else {
                vBox.className = "alert alert-secondary text-center fw-bold mb-3";
                vBox.innerText = "ìˆ˜ìµì´ ë™ì¼í•©ë‹ˆë‹¤.";
            }

            document.getElementById('resultBox').style.display = 'block';
            document.getElementById('resultBox').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜: " + e.message);
        }
    }

    function calcLoanDetails(principal, annualRate, totalYears, holdYears, graceYears) {
        if(principal <= 0) return { totalInterest:0, monthlyInterestOnly:0, monthlyFull:0 };
        const monthlyRate = annualRate / 12;
        const totalMonths = totalYears * 12;
        const graceMonths = graceYears * 12;
        const holdMonths = Math.floor(holdYears * 12);

        const monthlyInterestOnly = principal * monthlyRate;
        const repayMonths = totalMonths - graceMonths;
        let monthlyFull = 0;
        if (repayMonths > 0) {
            monthlyFull = principal * (monthlyRate * Math.pow(1+monthlyRate, repayMonths)) / (Math.pow(1+monthlyRate, repayMonths) - 1);
        }

        let totalInterestPaid = 0;
        let balance = principal;
        for(let m=1; m <= holdMonths; m++) {
            if (m <= graceMonths) {
                totalInterestPaid += balance * monthlyRate;
            } else {
                const interest = balance * monthlyRate;
                const principalRepay = monthlyFull - interest;
                totalInterestPaid += interest;
                balance -= principalRepay;
                if(balance <= 0) break;
            }
        }
        return { totalInterest: totalInterestPaid, monthlyInterestOnly: monthlyInterestOnly, monthlyFull: monthlyFull };
    }
</script>

</body>
</html>
